<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sistema de Manutenção — Gestão de Solicitações</title>

  <style>
    :root{
      --bg: #f3f5f9;
      --text: #0f172a;
      --muted: #64748b;
      --card: #ffffff;
      --line: rgba(15, 23, 42, .08);

      --blue: #2563eb;
      --blue-600: #1d4ed8;
      --orange: #f97316;
      --orange-600: #ea580c;
      --green: #16a34a;
      --green-600: #15803d;

      --shadow: 0 10px 25px rgba(2,6,23,.08);
      --shadow-soft: 0 6px 18px rgba(2,6,23,.06);
      --radius: 16px;
      --radius-sm: 12px;
      --container: 1100px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background: var(--bg);
    }

    /* ---------- Helpers ---------- */
    .container{ width: min(var(--container), calc(100% - 48px)); margin: 0 auto; }
    .row{ display:flex; gap: 18px; }
    .col{ flex:1; }
    .hidden{ display:none !important; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px;
      border: 1px solid var(--line);
      background:#fff; color: var(--text);
      padding: 10px 14px;
      border-radius: 10px;
      box-shadow: 0 1px 0 rgba(2,6,23,.03);
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
      user-select:none;
      font-weight: 700;
      font-size: 13px;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow-soft); border-color: rgba(15,23,42,.14); }
    .btn:active{ transform: translateY(0); }
    .btn.primary{ background: var(--blue); color: #fff; border-color: rgba(37,99,235,.25); }
    .btn.primary:hover{ background: var(--blue-600); }
    .btn.orange{ background: var(--orange); color:#fff; border-color: rgba(249,115,22,.25); }
    .btn.orange:hover{ background: var(--orange-600); }
    .btn.icon{ padding: 10px; width: 44px; height: 44px; }

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(15,23,42,.10);
      background: #fff;
      color: var(--text);
      white-space:nowrap;
      font-weight: 800;
    }
    .chip.orange{ background: rgba(249,115,22,.10); border-color: rgba(249,115,22,.22); color: #9a3412;}
    .chip.blue{ background: rgba(37,99,235,.10); border-color: rgba(37,99,235,.22); color: #1e40af;}
    .chip.green{ background: rgba(22,163,74,.10); border-color: rgba(22,163,74,.22); color: #14532d;}
    .chip.gray{ background: rgba(100,116,139,.10); border-color: rgba(100,116,139,.22); color: #334155;}

    .iconbox{
      width: 42px; height: 42px; border-radius: 12px;
      display:grid; place-items:center;
      box-shadow: 0 6px 18px rgba(2,6,23,.10);
    }
    .iconbox.blue{ background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .iconbox.orange{ background: linear-gradient(135deg, #fb923c, #ea580c); }
    .iconbox.wrenchHero{
      width: 52px; height: 52px; border-radius: 16px;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      box-shadow: 0 14px 30px rgba(37,99,235,.35);
    }
    .card{
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--line);
      box-shadow: var(--shadow-soft);
    }
    .muted{ color: var(--muted); }
    .title{ font-weight: 800; letter-spacing: -0.02em; }

    .input{
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      outline: none;
      transition: border-color .12s ease, box-shadow .12s ease;
      font-size: 14px;
    }
    .input:focus{
      border-color: rgba(37,99,235,.40);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }
    .field{ display:flex; flex-direction:column; gap: 6px; }
    .field label{ font-size: 12px; color: var(--muted); font-weight: 800; }
    .hint{ font-size: 12px; color: var(--muted); }

    /* ---------- Topbar (dashboard pages) ---------- */
    .topbar{
      height: 64px;
      display:flex;
      align-items:center;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.80);
      backdrop-filter: blur(10px);
      position: sticky; top: 0; z-index: 50;
    }
    .topbar .brand{
      display:flex; align-items:center; gap: 12px;
      font-weight: 900;
    }
    .topbar .brand small{ display:block; font-weight:800; color: var(--muted); margin-top: 2px; }
    .topbar .nav{
      margin-left: auto;
      display:flex; align-items:center; gap: 10px;
    }
    .pill{
      display:inline-flex; align-items:center; gap: 10px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      font-size: 13px;
      font-weight: 900;
    }
    .pill:hover{ transform: translateY(-1px); box-shadow: var(--shadow-soft); }
    .pill svg{ width: 16px; height: 16px; }

    /* ---------- HOME / HERO ---------- */
    .hero{
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 50px 0;
      position: relative;
      overflow:hidden;
    }
    .hero::before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(180deg, rgba(15,23,42,.65), rgba(15,23,42,.65)),
        radial-gradient(1000px 500px at 20% 10%, rgba(59,130,246,.35), transparent 60%),
        radial-gradient(900px 450px at 80% 25%, rgba(249,115,22,.22), transparent 55%),
        radial-gradient(1000px 600px at 50% 80%, rgba(2,132,199,.16), transparent 60%),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='800'%3E%3Cdefs%3E%3CradialGradient id='g' cx='50%25' cy='50%25' r='70%25'%3E%3Cstop offset='0%25' stop-color='%231e293b'/%3E%3Cstop offset='100%25' stop-color='%230b1220'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect width='1200' height='800' fill='url(%23g)'/%3E%3Cpath d='M0 600 C200 520 400 680 600 600 C800 520 1000 680 1200 600' stroke='%233b82f6' stroke-opacity='.16' stroke-width='6' fill='none'/%3E%3Cpath d='M0 650 C200 570 400 730 600 650 C800 570 1000 730 1200 650' stroke='%23fb923c' stroke-opacity='.12' stroke-width='6' fill='none'/%3E%3C/svg%3E");
      background-size: cover;
      filter: saturate(1.1);
      transform: scale(1.03);
    }
    .hero-inner{
      position: relative;
      width: min(980px, calc(100% - 48px));
      text-align: center;
      color: #e5e7eb;
    }
    .hero h1{
      margin: 18px 0 8px;
      color: #ffffff;
      font-size: clamp(24px, 3vw, 34px);
      letter-spacing: -0.03em;
    }
    .hero p{
      margin: 0 0 26px;
      color: rgba(226,232,240,.9);
      font-size: 13px;
    }
    .hero .cards{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 20px;
      margin-top: 26px;
    }
    @media (max-width: 720px){
      .hero .cards{ grid-template-columns: 1fr; }
    }
    .hero-card{
      text-align: left;
      background: rgba(255,255,255,.92);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.35);
      border-radius: 18px;
      padding: 22px;
      box-shadow: 0 20px 45px rgba(0,0,0,.22);
    }
    .hero-card h3{ margin: 14px 0 6px; font-size: 15px; letter-spacing:-0.01em; }
    .hero-card p{ margin: 0 0 14px; color: var(--muted); font-size: 12px; }
    .hero-card a{
      font-size: 13px; font-weight: 900;
      color: var(--blue);
      text-decoration:none;
      display:inline-flex; align-items:center; gap: 8px;
    }
    .hero-card a.orange{ color: var(--orange-600); }
    .hero-foot{
      margin-top: 16px;
      font-size: 12px;
      color: rgba(226,232,240,.75);
    }

    /* ---------- Dashboard layout ---------- */
    .page{
      min-height: 100vh;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(59,130,246,.12), transparent 60%),
        radial-gradient(900px 450px at 80% 25%, rgba(249,115,22,.10), transparent 55%),
        linear-gradient(180deg, #f7f9fc, #f6f4ef);
    }
    .main{ padding: 20px 0 50px; }
    .kpis{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 16px;
      margin: 10px 0 14px;
    }
    @media (max-width: 850px){
      .kpis{ grid-template-columns: 1fr; }
    }
    .kpi{
      padding: 16px 16px;
      color: #fff;
      border-radius: 16px;
      box-shadow: 0 16px 34px rgba(2,6,23,.10);
      position: relative;
      overflow:hidden;
    }
    .kpi::after{
      content:"";
      position:absolute; inset:-60px -120px auto auto;
      width: 240px; height: 240px;
      border-radius: 999px;
      background: rgba(255,255,255,.14);
      transform: rotate(25deg);
    }
    .kpi .label{ font-size: 12px; opacity: .92; font-weight: 800; }
    .kpi .value{ font-size: 28px; font-weight: 1000; margin-top: 6px; letter-spacing:-0.03em; }
    .kpi.orange{ background: linear-gradient(135deg, #f59e0b, #ea580c); }
    .kpi.blue{ background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .kpi.green{ background: linear-gradient(135deg, #22c55e, #16a34a); }

    .toolbar{
      display:flex;
      gap: 12px;
      align-items:center;
      margin: 10px 0 16px;
      flex-wrap: wrap;
    }
    .toolbar .search{
      flex:1;
      min-width: 260px;
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.85);
    }
    .toolbar .search svg{ width: 16px; height: 16px; color: var(--muted); }
    .toolbar .search input{
      border: none; outline: none; background: transparent;
      width: 100%;
      font-size: 14px;
    }
    .list{ display:flex; flex-direction:column; gap: 12px; }
    .item{
      display:flex;
      gap: 12px;
      padding: 14px 14px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 6px 18px rgba(2,6,23,.05);
      align-items: flex-start;
    }
    .item:hover{ border-color: rgba(15,23,42,.14); }
    .item .content{ flex:1; }
    .item .top{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .item h4{ margin:0; font-size: 13px; letter-spacing:-0.01em; }
    .item .meta{
      display:flex;
      flex-wrap: wrap;
      gap: 12px;
      color: var(--muted);
      font-size: 12px;
      align-items:center;
    }
    .meta span{ display:inline-flex; align-items:center; gap: 6px; }
    .meta svg{ width: 14px; height: 14px; opacity: .8; }
    .item .desc{ margin-top: 6px; font-size: 12px; color: var(--muted); }
    .item .go{ margin-left:auto; display:flex; align-items:center; gap:8px; color: var(--muted); padding-top: 6px; }
    .item .go svg{ width: 18px; height: 18px; }

    /* ---------- CO Form (Tela 2) ---------- */
    .form-card{
      padding: 16px;
      border: 1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 6px 18px rgba(2,6,23,.05);
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 14px;
    }
    @media (max-width: 850px){
      .grid{ grid-template-columns: 1fr; }
    }
    .grid .full{ grid-column: 1 / -1; }
    .preview{
      display:flex;
      gap: 12px;
      align-items:flex-start;
      padding: 12px;
      border: 1px dashed rgba(15,23,42,.18);
      border-radius: 14px;
      background: rgba(248,250,252,.75);
    }
    .preview img{
      width: 120px;
      height: 86px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid rgba(15,23,42,.10);
      background: #fff;
    }
    .req{ display:inline-flex; align-items:center; gap:6px; font-size: 12px; color: #b45309; font-weight: 900; }

    /* ---------- Teams ---------- */
    .teams{ display:flex; flex-direction:column; gap: 12px; margin-top: 12px; }
    .team-card{
      padding: 14px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 6px 18px rgba(2,6,23,.05);
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 14px;
    }
    .team-card .left{ flex:1; }
    .team-title{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom: 6px; }
    .team-title h4{ margin:0; font-size: 13px; }
    .members{ display:flex; flex-wrap:wrap; gap: 8px; margin-top: 10px; }
    .tag{
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(15,23,42,.06);
      border: 1px solid rgba(15,23,42,.08);
      color: #0f172a;
      font-weight: 800;
    }
    .team-actions{ display:flex; gap: 10px; flex-wrap: wrap; }

    /* ---------- Modal ---------- */
    .modal-overlay{
      position: fixed; inset: 0;
      background: rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 22px;
      z-index: 100;
    }
    .modal{
      width: min(560px, 100%);
      background: #fff;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.25);
      box-shadow: 0 25px 70px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modal header{
      padding: 14px 16px;
      display:flex; align-items:center; justify-content: space-between;
      border-bottom: 1px solid var(--line);
      background: rgba(248,250,252,.9);
    }
    .modal header h3{ margin:0; font-size: 14px; }
    .modal .body{ padding: 16px; display:flex; flex-direction:column; gap: 10px; }
    .modal .footer{ padding: 14px 16px; border-top: 1px solid var(--line); display:flex; gap: 10px; justify-content:flex-end; }
    .modal-overlay.show{ display:flex; }

    /* ---------- SVG ---------- */
    svg{ fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

    a.link{ color: var(--blue); font-weight: 900; text-decoration:none; }
    a.link:hover{ text-decoration: underline; }

  </style>
</head>

<body>

  <!-- =========================
       HOME (Tela 1)
  ========================== -->
  <section id="view-home" class="hero">
    <div class="hero-inner">
      <div class="iconbox wrenchHero" style="margin:0 auto; display:grid; place-items:center; color:#fff;">
        <svg width="24" height="24" viewBox="0 0 24 24">
          <path d="M21 7.5a5.5 5.5 0 0 1-7.7 5.1L6.2 19.7a2 2 0 0 1-2.8 0l-.1-.1a2 2 0 0 1 0-2.8l7.1-7.1A5.5 5.5 0 0 1 16.5 2l-2 2 2.5 2.5 2-2A5.5 5.5 0 0 1 21 7.5Z"/>
        </svg>
      </div>

      <h1 class="title">Sistema de Manutenção</h1>
      <p>Gestão de Solicitações de Serviço</p>

      <div class="cards">
        <div class="hero-card">
          <div class="iconbox blue" style="color:#fff;">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path d="M3 21V3h12v18"/>
              <path d="M7 7h4"/>
              <path d="M7 11h4"/>
              <path d="M7 15h4"/>
              <path d="M15 9h6v12h-6"/>
              <path d="M18 13h.01"/>
              <path d="M18 17h.01"/>
            </svg>
          </div>
          <h3>Centro de Operação</h3>
          <p>Abra novas solicitações de serviço de manutenção e acompanhe o andamento.</p>
          <a href="#" id="go-co">
            Acessar
            <svg width="18" height="18" viewBox="0 0 24 24">
              <path d="M5 12h14"/>
              <path d="M13 6l6 6-6 6"/>
            </svg>
          </a>
        </div>

        <div class="hero-card">
          <div class="iconbox orange" style="color:#fff;">
            <svg width="20" height="20" viewBox="0 0 24 24">
              <path d="M21 7.5a5.5 5.5 0 0 1-7.7 5.1L6.2 19.7a2 2 0 0 1-2.8 0l-.1-.1a2 2 0 0 1 0-2.8l7.1-7.1A5.5 5.5 0 0 1 16.5 2l-2 2 2.5 2.5 2-2A5.5 5.5 0 0 1 21 7.5Z"/>
            </svg>
          </div>
          <h3>Manutenção</h3>
          <p>Gerencie as solicitações, dê início aos serviços e finalize os atendimentos.</p>
          <a href="#" class="orange" id="go-manut">
            Acessar
            <svg width="18" height="18" viewBox="0 0 24 24">
              <path d="M5 12h14"/>
              <path d="M13 6l6 6-6 6"/>
            </svg>
          </a>
        </div>
      </div>

      <div class="hero-foot">Selecione seu perfil para continuar</div>
    </div>
  </section>

  <!-- =========================
       CENTRO DE OPERAÇÃO (Tela 2)
  ========================== -->
  <section id="view-co" class="page hidden">
    <div class="topbar">
      <div class="container" style="display:flex; align-items:center; gap: 14px;">
        <a href="#" id="back-from-co" class="pill" style="text-decoration:none;">
          <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
          Voltar
        </a>

        <div class="brand" style="margin-left:4px;">
          <div class="iconbox blue" style="color:#fff; width:34px; height:34px; border-radius:10px; box-shadow:none;">
            <svg width="18" height="18" viewBox="0 0 24 24">
              <path d="M3 21V3h12v18"/>
              <path d="M7 7h4"/>
              <path d="M7 11h4"/>
              <path d="M7 15h4"/>
              <path d="M15 9h6v12h-6"/>
            </svg>
          </div>
          <div>
            <div>Centro de Operação</div>
            <small>Solicitação de Serviço</small>
          </div>
        </div>

        <div class="nav">
          <div class="pill" id="co-nav-historico">
            <svg viewBox="0 0 24 24">
              <path d="M3 3v5h5"/>
              <path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/>
              <path d="M12 7v5l4 2"/>
            </svg>
            Histórico
          </div>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="container">
        <div class="form-card">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;">
            <div>
              <div class="title" style="font-size:16px;">Nova Solicitação</div>
              <div class="hint">Preencha os dados abaixo para abrir uma solicitação de manutenção.</div>
            </div>
            <div>
              <span class="chip orange">● Status: Pendente</span>
            </div>
          </div>

          <form id="co-form">
            <div class="grid">
              <div class="field">
                <label>Número da OC <span class="req">• obrigatório</span></label>
                <input class="input" id="co-oc" placeholder="Ex.: OC-9004" required />
              </div>

              <div class="field">
                <label>NDS <span class="req">• obrigatório</span></label>
                <input class="input" id="co-nds" placeholder="Ex.: NDS-44556" required />
              </div>

              <div class="field">
                <label>Região <span class="req">• obrigatório</span></label>
                <select class="input" id="co-regiao" required>
                  <option value="" selected disabled>Selecione...</option>
                  <option value="Norte">Norte</option>
                  <option value="Sul">Sul</option>
                </select>
              </div>

              <div class="field">
                <label>Seccional <span class="req">• obrigatório</span></label>
                <select class="input" id="co-seccional" required disabled>
                  <option value="" selected>Selecione a região...</option>
                </select>
              </div>

              <div class="field">
                <label>Cidade <span class="req">• obrigatório</span></label>
                <input class="input" id="co-cidade" placeholder="Ex.: Porto Alegre" required />
              </div>

              <div class="field">
                <label>Equipamento <span class="req">• obrigatório</span></label>
                <input class="input" id="co-equip" placeholder="Ex.: Transformador / Disjuntor / Poste" required />
              </div>

              <div class="field full">
                <label>Serviço <span class="req">• obrigatório</span></label>
                <textarea class="input" id="co-servico" rows="3" placeholder="Descreva o problema/serviço..." required></textarea>
              </div>

              <div class="field">
                <label>Tipo de manutenção (opcional)</label>
                <select class="input" id="co-tipo">
                  <option value="">Não informado</option>
                  <option value="Corretiva">Corretiva</option>
                  <option value="Preventiva">Preventiva</option>
                  <option value="Emergencial">Emergencial</option>
                </select>
              </div>

              <div class="field">
                <label>Foto do problema (opcional)</label>
                <input class="input" id="co-foto" type="file" accept="image/*" />
              </div>

              <div class="field full">
                <div class="preview">
                  <img id="co-foto-preview" alt="Prévia" src="" style="display:none;">
                  <div>
                    <div style="font-weight:900; font-size:13px;">Prévia da Foto</div>
                    <div class="hint" id="co-foto-hint">Nenhuma imagem selecionada.</div>
                    <div class="hint" style="margin-top:8px;">
                      Dica: imagens muito grandes podem ultrapassar o limite do LocalStorage em alguns navegadores.
                    </div>
                  </div>
                </div>
              </div>

              <div class="field full" style="display:flex; flex-direction:row; gap:12px; justify-content:flex-end; align-items:center;">
                <button type="button" class="btn" id="co-limpar">Limpar</button>
                <button type="submit" class="btn primary" id="co-enviar">
                  Enviar solicitação
                  <svg width="16" height="16" viewBox="0 0 24 24">
                    <path d="M22 2 11 13"></path>
                    <path d="M22 2 15 22 11 13 2 9 22 2Z"></path>
                  </svg>
                </button>
              </div>
            </div>
          </form>

        </div>

        <div class="hint" style="margin-top:10px;">
          Após enviar, a solicitação aparecerá em <b>Manutenção</b> e no <b>Histórico</b>.
        </div>
      </div>
    </div>
  </section>

  <!-- =========================
       MANUTENÇÃO DASHBOARD (Tela 3)
  ========================== -->
  <section id="view-manut" class="page hidden">
    <div class="topbar">
      <div class="container" style="display:flex; align-items:center; gap: 14px;">
        <div class="brand">
          <div class="iconbox orange" style="color:#fff; width:34px; height:34px; border-radius:10px; box-shadow:none;">
            <svg width="18" height="18" viewBox="0 0 24 24">
              <path d="M21 7.5a5.5 5.5 0 0 1-7.7 5.1L6.2 19.7a2 2 0 0 1-2.8 0l-.1-.1a2 2 0 0 1 0-2.8l7.1-7.1A5.5 5.5 0 0 1 16.5 2l-2 2 2.5 2.5 2-2A5.5 5.5 0 0 1 21 7.5Z"/>
            </svg>
          </div>
          <div>
            <div>Manutenção</div>
            <small>Solicitações de Serviço</small>
          </div>
        </div>

        <div class="nav">
          <div class="pill" id="nav-equipes">
            <svg viewBox="0 0 24 24">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <path d="M9 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            Equipes
          </div>
          <div class="pill" id="nav-historico">
            <svg viewBox="0 0 24 24">
              <path d="M3 3v5h5"/>
              <path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/>
              <path d="M12 7v5l4 2"/>
            </svg>
            Histórico
          </div>
          <div class="pill" id="nav-sair">
            <svg viewBox="0 0 24 24">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
              <path d="M16 17l5-5-5-5"/>
              <path d="M21 12H9"/>
            </svg>
            Sair
          </div>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="container">
        <div class="kpis">
          <div class="kpi orange">
            <div class="label">Pendentes</div>
            <div class="value" id="kpi-pendentes">0</div>
          </div>
          <div class="kpi blue">
            <div class="label">Em andamento</div>
            <div class="value" id="kpi-andamento">0</div>
          </div>
          <div class="kpi green">
            <div class="label">Concluídos</div>
            <div class="value" id="kpi-concluidos">0</div>
          </div>
        </div>

        <div class="toolbar">
          <div class="search">
            <svg viewBox="0 0 24 24">
              <circle cx="11" cy="11" r="7"></circle>
              <path d="M21 21l-4.3-4.3"></path>
            </svg>
            <input id="search-manut" placeholder="Buscar por NDS, OC ou cidade..." />
          </div>

          <button class="btn" id="btn-export-manut-csv" title="Exportar lista (CSV)">Exportar CSV</button>
          <button class="btn orange" id="btn-export-manut-xls" title="Exportar lista (Excel)">Exportar Excel</button>

          <button class="btn icon" id="btn-refresh" title="Atualizar lista">
            <svg viewBox="0 0 24 24">
              <path d="M21 12a9 9 0 1 1-3-6.7"></path>
              <path d="M21 3v6h-6"></path>
            </svg>
          </button>
        </div>

        <div class="list" id="list-manut"></div>
      </div>
    </div>
  </section>

  <!-- =========================
       HISTÓRICO (Tela 5)
  ========================== -->
  <section id="view-historico" class="page hidden">
    <div class="topbar">
      <div class="container" style="display:flex; align-items:center; gap:14px;">
        <a href="#" id="back-from-historico" class="pill" style="text-decoration:none;">
          <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
          Histórico de Solicitações
        </a>
        <div class="nav" style="margin-left:auto;">
          <button class="btn icon" id="btn-refresh-hist" title="Atualizar">
            <svg viewBox="0 0 24 24">
              <path d="M21 12a9 9 0 1 1-3-6.7"></path>
              <path d="M21 3v6h-6"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="container">
        <div style="margin-top:10px" class="muted" id="hist-count">0 registros encontrados</div>

        <div class="toolbar" style="margin-top:12px;">
          <div class="search">
            <svg viewBox="0 0 24 24">
              <circle cx="11" cy="11" r="7"></circle>
              <path d="M21 21l-4.3-4.3"></path>
            </svg>
            <input id="search-hist" placeholder="Buscar por NDS, OC ou cidade..." />
          </div>

          <button class="btn" id="btn-filtros">
            <svg width="16" height="16" viewBox="0 0 24 24">
              <path d="M22 3H2l8 9v7l4 2v-9l8-9Z"/>
            </svg>
            Filtros
          </button>

          <button class="btn" id="btn-export-csv" title="Exportar histórico (CSV)">Exportar CSV</button>
          <button class="btn orange" id="btn-export-xls" title="Exportar histórico (Excel)">Exportar Excel</button>
        </div>

        <div class="list" id="list-hist"></div>
      </div>
    </div>
  </section>

  <!-- =========================
       EQUIPES
  ========================== -->
  <section id="view-equipes" class="page hidden">
    <div class="topbar">
      <div class="container" style="display:flex; align-items:center; gap:14px;">
        <a href="#" id="back-from-equipes" class="pill" style="text-decoration:none;">
          <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
          Gerenciar Equipes
        </a>
        <div class="nav" style="margin-left:auto;">
          <button class="btn orange" id="btn-nova-equipe">
            <svg width="16" height="16" viewBox="0 0 24 24">
              <path d="M12 5v14"/>
              <path d="M5 12h14"/>
            </svg>
            Nova Equipe
          </button>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="container">
        <div class="muted" id="teams-count">0 equipes cadastradas</div>
        <div class="teams" id="teams-list"></div>
      </div>
    </div>
  </section>

  <!-- =========================
       MODAL: FILTROS
  ========================== -->
  <div class="modal-overlay" id="modal-filtros">
    <div class="modal">
      <header>
        <h3>Filtros</h3>
        <button class="btn icon" id="close-filtros" aria-label="Fechar">
          <svg viewBox="0 0 24 24">
            <path d="M18 6 6 18"/>
            <path d="M6 6l12 12"/>
          </svg>
        </button>
      </header>

      <div class="body">
        <label class="muted" style="font-size:12px;">Status</label>
        <select class="input" id="filter-status">
          <option value="">Todos</option>
          <option value="Pendente">Pendente</option>
          <option value="Em andamento">Em andamento</option>
          <option value="Concluído">Concluído</option>
        </select>

        <label class="muted" style="font-size:12px;">Região</label>
        <select class="input" id="filter-regiao">
          <option value="">Todas</option>
          <option value="Norte">Norte</option>
          <option value="Sul">Sul</option>
        </select>

        <label class="muted" style="font-size:12px;">Seccional</label>
        <input class="input" id="filter-seccional" placeholder="Ex.: Porto Alegre" />

        <label class="muted" style="font-size:12px;">Tipo de manutenção</label>
        <select class="input" id="filter-tipo">
          <option value="">Todos</option>
          <option value="Corretiva">Corretiva</option>
          <option value="Preventiva">Preventiva</option>
          <option value="Emergencial">Emergencial</option>
        </select>
      </div>

      <div class="footer">
        <button class="btn" id="btn-limpar-filtros">Limpar</button>
        <button class="btn primary" id="btn-aplicar-filtros">Aplicar</button>
      </div>
    </div>
  </div>

  <!-- =========================
       MODAL: NOVA/EDITAR EQUIPE
  ========================== -->
  <div class="modal-overlay" id="modal-equipe">
    <div class="modal">
      <header>
        <h3 id="modal-equipe-title">Nova Equipe</h3>
        <button class="btn icon" id="close-equipe" aria-label="Fechar">
          <svg viewBox="0 0 24 24">
            <path d="M18 6 6 18"/>
            <path d="M6 6l12 12"/>
          </svg>
        </button>
      </header>

      <div class="body">
        <div class="field">
          <label>Nome da equipe <span class="req">• obrigatório</span></label>
          <input class="input" id="eq-nome" placeholder="Ex.: Equipe Delta" />
        </div>

        <div class="field">
          <label>Membros (separe por vírgula)</label>
          <input class="input" id="eq-membros" placeholder="Ex.: Ana, Pedro, Lucas" />
          <div class="hint">Dica: você pode editar depois.</div>
        </div>

        <div class="field">
          <label>Status</label>
          <select class="input" id="eq-ativa">
            <option value="true" selected>Ativa</option>
            <option value="false">Inativa</option>
          </select>
        </div>

        <div class="hint muted" id="eq-msg" style="display:none;"></div>
      </div>

      <div class="footer">
        <button class="btn" id="btn-cancelar-equipe">Cancelar</button>
        <button class="btn primary" id="btn-salvar-equipe">Salvar</button>
      </div>
    </div>
  </div>

  <!-- =========================
       MODAL: ATRIBUIR EQUIPE
  ========================== -->
  <div class="modal-overlay" id="modal-atribuir">
    <div class="modal">
      <header>
        <h3>Atribuir Equipe</h3>
        <button class="btn icon" id="close-atribuir" aria-label="Fechar">
          <svg viewBox="0 0 24 24">
            <path d="M18 6 6 18"/>
            <path d="M6 6l12 12"/>
          </svg>
        </button>
      </header>

      <div class="body">
        <div class="muted" style="font-size:12px;">Solicitação</div>
        <div id="atribuir-info" style="font-weight:900; font-size:13px;">—</div>

        <div class="field" style="margin-top:10px;">
          <label>Equipe (apenas ativas)</label>
          <select class="input" id="atribuir-equipe"></select>
        </div>

        <div class="hint">
          Ao atribuir, a solicitação muda de <b>Pendente</b> para <b>Em andamento</b>.
        </div>
      </div>

      <div class="footer">
        <button class="btn" id="btn-cancelar-atribuir">Cancelar</button>
        <button class="btn primary" id="btn-confirmar-atribuir">Atribuir</button>
      </div>
    </div>
  </div>

  <!-- =========================
       MODAL: CONCLUIR ATENDIMENTO
  ========================== -->
  <div class="modal-overlay" id="modal-concluir">
    <div class="modal">
      <header>
        <h3>Concluir atendimento</h3>
        <button class="btn icon" id="close-concluir" aria-label="Fechar">
          <svg viewBox="0 0 24 24">
            <path d="M18 6 6 18"/>
            <path d="M6 6l12 12"/>
          </svg>
        </button>
      </header>

      <div class="body">
        <div class="muted" style="font-size:12px;">Solicitação</div>
        <div id="concluir-info" style="font-weight:900; font-size:13px;">—</div>

        <div class="field" style="margin-top:10px;">
          <label>Descrição do serviço executado <span class="req">• obrigatório</span></label>
          <textarea class="input" id="concluir-descricao" rows="3" placeholder="Ex.: Substituído disjuntor, realizados testes e normalização do circuito..."></textarea>
        </div>

        <div class="field">
          <label>Materiais utilizados (opcional)</label>
          <input class="input" id="concluir-materiais" placeholder="Ex.: Disjuntor 15kV, conectores, fita isolante..." />
        </div>

        <div class="field">
          <label>Foto do serviço concluído (opcional)</label>
          <input class="input" id="concluir-foto" type="file" accept="image/*" />
        </div>

        <div class="field">
          <div class="preview">
            <img id="concluir-foto-preview" alt="Prévia" src="" style="display:none;" />
            <div>
              <div style="font-weight:900; font-size:13px;">Prévia da Foto</div>
              <div class="hint" id="concluir-foto-hint">Nenhuma imagem selecionada.</div>
              <div class="hint" style="margin-top:8px;">Dica: imagens muito grandes podem ultrapassar o limite do LocalStorage.</div>
            </div>
          </div>
        </div>

        <div class="hint muted" id="concluir-msg" style="display:none;"></div>
      </div>

      <div class="footer">
        <button class="btn" id="btn-cancelar-concluir">Cancelar</button>
        <button class="btn primary" id="btn-confirmar-concluir">Concluir</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================================================
    // LocalStorage keys
    // ==========================================================
    const LS_SOL = "sm_solicitacoes_v2";
    const LS_EQP = "sm_equipes_v2";

    // ==========================================================
    // Utils
    // ==========================================================
    function nowBR(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
    }

    function safeJSONParse(raw, fallback){
      try{ return raw ? JSON.parse(raw) : fallback; }
      catch{ return fallback; }
    }

    function nextId(arr){
      return arr.reduce((m,x) => Math.max(m, Number(x.id||0)), 0) + 1;
    }

    // ==========================================================
    // Workflow (status automático)
    // ==========================================================
    function normalizeSolicitacao(s){
      if(s.status === "Concluído") return s;
      if(s.equipeId) s.status = "Em andamento";
      else s.status = "Pendente";
      return s;
    }
    function normalizeAllSolicitacoes(arr){
      return arr.map(normalizeSolicitacao);
    }

    // ==========================================================
    // Storage: Solicitações
    // ==========================================================
    function getSolicitacoes(){
      const arr = safeJSONParse(localStorage.getItem(LS_SOL), []);
      return normalizeAllSolicitacoes(arr);
    }
    function setSolicitacoes(arr){
      localStorage.setItem(LS_SOL, JSON.stringify(arr));
    }

    async async function seedSolicitacoesIfEmpty(){
      const current = getSolicitacoes();
      if(current.length) return;
      try{
        const res = await fetch('data/solicitacoes.json', { cache: 'no-store' });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const seed = await res.json();
        if(Array.isArray(seed)) setSolicitacoes(normalizeAllSolicitacoes(seed));
        else throw new Error('JSON inválido');
      }catch(err){
        // Sem dados iniciais (começando do zero)
        setSolicitacoes([]);
      }
    }

    // ==========================================================
    // Storage: Equipes
    // ==========================================================
    function getEquipes(){
      return safeJSONParse(localStorage.getItem(LS_EQP), []);
    }
    function setEquipes(arr){
      localStorage.setItem(LS_EQP, JSON.stringify(arr));
    }
    async function seedEquipesIfEmpty(){

const current = getEquipes();
if(current.length) return;
// tenta carregar do repositório (GitHub Pages) em /data/equipes.json
try{
  const res = await fetch('data/equipes.json', { cache: 'no-store' });
  if(!res.ok) throw new Error('HTTP ' + res.status);
  const seed = await res.json();
  if(Array.isArray(seed)) setEquipes(seed);
  else throw new Error('JSON inválido');
}catch(err){
        // Sem dados iniciais (começando do zero)
        setEquipes([]);
      
}
}

    function getEquipeById(id){
      return getEquipes().find(e => Number(e.id) === Number(id)) || null;
    }

    // ==========================================================
    // Router
    // ==========================================================
    const views = {
      home: document.getElementById("view-home"),
      co: document.getElementById("view-co"),
      manut: document.getElementById("view-manut"),
      historico: document.getElementById("view-historico"),
      equipes: document.getElementById("view-equipes")
    };

    function showView(name){
      Object.values(views).forEach(v => v.classList.add("hidden"));
      views[name].classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // ==========================================================
    // UI helpers
    // ==========================================================
    function statusChip(status){
      if(status === "Pendente") return `<span class="chip orange">● ${status}</span>`;
      if(status === "Em andamento") return `<span class="chip blue">● ${status}</span>`;
      return `<span class="chip green">● ${status}</span>`;
    }

    function teamChip(equipeId){
      if(!equipeId) return `<span class="chip gray">Equipe: —</span>`;
      const eq = getEquipeById(equipeId);
      if(!eq) return `<span class="chip gray">Equipe: (removida)</span>`;
      return `<span class="chip gray">Equipe: ${eq.nome}</span>`;
    }

    function pinIcon(){
      return `
        <svg viewBox="0 0 24 24">
          <path d="M12 21s-6-4.35-6-10a6 6 0 1 1 12 0c0 5.65-6 10-6 10Z"></path>
          <circle cx="12" cy="11" r="2"></circle>
        </svg>
      `;
    }
    function clockIcon(){
      return `
        <svg viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="9"></circle>
          <path d="M12 7v5l3 2"></path>
        </svg>
      `;
    }
    function chevronIcon(){
      return `
        <svg viewBox="0 0 24 24">
          <path d="M9 18l6-6-6-6"></path>
        </svg>
      `;
    }

    // ==========================================================
    // Render: Manutenção (com ações)
    // ==========================================================
    function renderManutList(query=""){
      const list = document.getElementById("list-manut");
      const data = getSolicitacoes();

      const q = query.trim().toLowerCase();
      const filtered = data.filter(s => {
        if(!q) return true;
        return (s.nds + " " + s.oc + " " + s.cidade + " " + s.seccional + " " + s.regiao)
          .toLowerCase()
          .includes(q);
      });

      filtered.sort((a,b) => (b.id||0) - (a.id||0));

      list.innerHTML = filtered.map(s => {
        const effectiveStatus = s.status; // já normalizado
        const canAssign = effectiveStatus !== "Concluído";
        const canFinish = effectiveStatus === "Em andamento";
        const assignLabel = s.equipeId ? "Trocar equipe" : "Atribuir equipe";
        const removeTeamBtn = (s.equipeId && effectiveStatus !== "Concluído")
          ? `<button class="btn" data-action="unassign" data-id="${s.id}">Remover equipe</button>`
          : "";

        const fotoLinks = `
          ${(s.fotoProblema ? `<a class="link" href="${s.fotoProblema}" target="_blank">Ver foto problema</a>` : ``)}
          ${(s.fotoConclusao ? `<a class="link" href="${s.fotoConclusao}" target="_blank">Ver foto conclusão</a>` : ``)}
        `;

        return `
          <div class="item">
            <div class="content">
              <div class="top">
                <h4>NDS: ${s.nds} • OC: ${s.oc}</h4>
                ${statusChip(effectiveStatus)}
              </div>

              <div class="meta">
                <span>${pinIcon()} ${s.regiao} - ${s.seccional} • ${s.cidade}</span>
                <span>${clockIcon()} ${s.data}</span>
                ${teamChip(s.equipeId)}
                ${(s.tipo ? `<span class="chip gray">Tipo: ${s.tipo}</span>` : ``)}
              </div>

              <div class="desc"><b>Equipamento:</b> ${s.equipamento} — ${s.servico || ""}</div>

              ${(s.status === "Concluído" ? `
                <div class="desc" style="margin-top:8px;">
                  <b>Concluído em:</b> ${s.dataConclusao || "—"}<br>
                  <b>Serviço executado:</b> ${s.servicoExecutado || "—"}<br>
                  <b>Materiais:</b> ${s.materiaisUtilizados || "—"}
                </div>
              ` : ``)}

              ${(s.fotoProblema || s.fotoConclusao) ? `<div class="desc" style="margin-top:8px; display:flex; gap:12px; flex-wrap:wrap;">${fotoLinks}</div>` : ``}

              <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                ${canAssign ? `<button class="btn" data-action="assign" data-id="${s.id}">${assignLabel}</button>` : ""}
                ${removeTeamBtn}
                ${canFinish ? `<button class="btn primary" data-action="finish" data-id="${s.id}">Concluir</button>` : ""}
              </div>
            </div>

            <div class="go" title="Detalhes (mock)">
              ${chevronIcon()}
            </div>
          </div>
        `;
      }).join("") || `<div class="muted">Nenhuma solicitação encontrada.</div>`;

      // KPIs (sobre o conjunto filtrado)
      const pend = filtered.filter(x => x.status === "Pendente").length;
      const anda = filtered.filter(x => x.status === "Em andamento").length;
      const concl = filtered.filter(x => x.status === "Concluído").length;

      document.getElementById("kpi-pendentes").textContent = pend;
      document.getElementById("kpi-andamento").textContent = anda;
      document.getElementById("kpi-concluidos").textContent = concl;
    }

    document.getElementById("list-manut").addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if(!btn) return;
      const action = btn.getAttribute("data-action");
      const id = Number(btn.getAttribute("data-id"));

      if(action === "assign") openAssignModal(id);
      if(action === "unassign") unassignEquipe(id);
      if(action === "finish") openConcluirModal(id);
    });

    function unassignEquipe(id){
      const data = getSolicitacoes();
      const idx = data.findIndex(s => Number(s.id) === Number(id));
      if(idx < 0) return;
      if(data[idx].status === "Concluído") return;

      data[idx].equipeId = null;
      normalizeSolicitacao(data[idx]);
      setSolicitacoes(data);

      renderManutList(document.getElementById("search-manut").value || "");
      renderHistorico(document.getElementById("search-hist").value || "", filtrosAtuais);
    }

    // ==========================================================
    // Render: Histórico (com filtros)
    // ==========================================================
    let filtrosAtuais = { status: "", regiao: "", seccional: "", tipo: "" };

    function renderHistorico(query="", filtros={}){
      const list = document.getElementById("list-hist");
      const count = document.getElementById("hist-count");
      const data = getSolicitacoes();

      const q = query.trim().toLowerCase();

      let filtered = data.filter(s => {
        const okBusca = !q || (s.nds + " " + s.oc + " " + s.cidade + " " + s.seccional + " " + s.regiao)
          .toLowerCase()
          .includes(q);
        if(!okBusca) return false;

        if(filtros.status && s.status !== filtros.status) return false;
        if(filtros.regiao && s.regiao !== filtros.regiao) return false;
        if(filtros.seccional && !(String(s.seccional||"").toLowerCase().includes(String(filtros.seccional).toLowerCase()))) return false;
        if(filtros.tipo && s.tipo !== filtros.tipo) return false;

        return true;
      });

      filtered.sort((a,b) => (b.id||0) - (a.id||0));
      count.textContent = `${filtered.length} registros encontrados`;

      list.innerHTML = filtered.map(s => {
        const fotoLinks = `
          ${(s.fotoProblema ? `<a class="link" href="${s.fotoProblema}" target="_blank">Ver foto problema</a>` : ``)}
          ${(s.fotoConclusao ? `<a class="link" href="${s.fotoConclusao}" target="_blank">Ver foto conclusão</a>` : ``)}
        `;

        return `
          <div class="item">
            <div class="content">
              <div class="top">
                <h4>NDS: ${s.nds} • OC: ${s.oc}</h4>
                ${statusChip(s.status)}
              </div>

              <div class="meta">
                <span>${pinIcon()} ${s.regiao} - ${s.seccional} • ${s.cidade}</span>
                <span>${clockIcon()} ${s.data}</span>
                <span class="chip gray">Tipo: ${s.tipo || "Não informado"}</span>
                ${teamChip(s.equipeId)}
              </div>

              <div class="desc"><b>Equipamento:</b> ${s.equipamento} — ${s.servico || ""}</div>

              ${(s.status === "Concluído" ? `
                <div class="desc" style="margin-top:8px;">
                  <b>Concluído em:</b> ${s.dataConclusao || "—"}<br>
                  <b>Serviço executado:</b> ${s.servicoExecutado || "—"}<br>
                  <b>Materiais:</b> ${s.materiaisUtilizados || "—"}
                </div>
              ` : ``)}

              ${(s.fotoProblema || s.fotoConclusao) ? `<div class="desc" style="margin-top:8px; display:flex; gap:12px; flex-wrap:wrap;">${fotoLinks}</div>` : ``}

            </div>

            <div class="go" title="Detalhes (mock)">
              ${chevronIcon()}
            </div>
          </div>
        `;
      }).join("") || `<div class="muted">Nenhum registro encontrado.</div>`;
    }

    // ==========================================================
    // Render: Equipes (persistente + ações)
    // ==========================================================
    function renderEquipes(){
      const list = document.getElementById("teams-list");
      const count = document.getElementById("teams-count");
      const data = getEquipes();

      count.textContent = `${data.length} equipes cadastradas`;

      list.innerHTML = data.map(t => `
        <div class="team-card">
          <div class="left">
            <div class="team-title">
              <h4>${t.nome}</h4>
              ${t.ativa ? `<span class="chip green">● Ativa</span>` : `<span class="chip gray">● Inativa</span>`}
            </div>
            <div class="muted" style="font-size:12px;">Membros</div>
            <div class="members">
              ${(t.membros || []).map(m => `<span class="tag">${m}</span>`).join("") || `<span class="muted">Sem membros</span>`}
            </div>
          </div>

          <div class="team-actions">
            <button class="btn" data-eq-action="edit" data-eq-id="${t.id}">Editar</button>
            <button class="btn" data-eq-action="toggle" data-eq-id="${t.id}">${t.ativa ? "Desativar" : "Ativar"}</button>
            <button class="btn" data-eq-action="delete" data-eq-id="${t.id}">Excluir</button>
          </div>
        </div>
      `).join("") || `<div class="muted">Nenhuma equipe cadastrada.</div>`;
    }

    document.getElementById("teams-list").addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-eq-action]");
      if(!btn) return;
      const action = btn.getAttribute("data-eq-action");
      const id = Number(btn.getAttribute("data-eq-id"));

      if(action === "edit") openEquipeModal(id);
      if(action === "toggle") toggleEquipe(id);
      if(action === "delete") deleteEquipe(id);
    });

    function toggleEquipe(id){
      const data = getEquipes();
      const idx = data.findIndex(x => Number(x.id) === Number(id));
      if(idx < 0) return;
      data[idx].ativa = !data[idx].ativa;
      setEquipes(data);
      renderEquipes();
    }

    function deleteEquipe(id){
      const data = getEquipes();
      const next = data.filter(x => Number(x.id) !== Number(id));
      setEquipes(next);
      renderEquipes();
      renderManutList(document.getElementById("search-manut").value || "");
      renderHistorico(document.getElementById("search-hist").value || "", filtrosAtuais);
    }

    // ==========================================================
    // Seccionais por região
    // ==========================================================
    const SECCIONAIS = {
      "Norte": ["Porto Alegre", "Litoral Norte", "Serra"],
      "Sul": ["Litoral Sul", "Pelotas", "Rio Grande"]
    };

    function updateSeccionais(){
      const reg = document.getElementById("co-regiao").value;
      const sel = document.getElementById("co-seccional");
      sel.innerHTML = "";

      if(!reg){
        sel.disabled = true;
        sel.innerHTML = `<option value="" selected>Selecione a região...</option>`;
        return;
      }

      const opts = SECCIONAIS[reg] || [];
      sel.disabled = false;
      sel.innerHTML = `<option value="" selected disabled>Selecione...</option>` +
        opts.map(o => `<option value="${o}">${o}</option>`).join("");
    }

    // ==========================================================
    // Foto -> base64 (opcional)
    // ==========================================================
    function fileToBase64(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ""));
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ==========================================================
    // Modal: Filtros
    // ==========================================================
    const modalFiltros = document.getElementById("modal-filtros");
    function openModalFiltros(){ modalFiltros.classList.add("show"); }
    function closeModalFiltros(){ modalFiltros.classList.remove("show"); }

    // ==========================================================
    // Modal: Equipe (nova/editar)
    // ==========================================================
    const modalEquipe = document.getElementById("modal-equipe");
    let equipeEditId = null;

    function openEquipeModal(id=null){
      equipeEditId = id;
      const title = document.getElementById("modal-equipe-title");
      const nome = document.getElementById("eq-nome");
      const membros = document.getElementById("eq-membros");
      const ativa = document.getElementById("eq-ativa");
      const msg = document.getElementById("eq-msg");

      msg.style.display = "none";
      msg.textContent = "";

      if(id){
        const eq = getEquipeById(id);
        title.textContent = "Editar Equipe";
        nome.value = eq ? eq.nome : "";
        membros.value = eq ? (eq.membros || []).join(", ") : "";
        ativa.value = eq && eq.ativa ? "true" : "false";
      }else{
        title.textContent = "Nova Equipe";
        nome.value = "";
        membros.value = "";
        ativa.value = "true";
      }

      modalEquipe.classList.add("show");
    }

    function closeEquipeModal(){
      modalEquipe.classList.remove("show");
      equipeEditId = null;
    }

    function saveEquipeFromModal(){
      const nome = document.getElementById("eq-nome").value.trim();
      const membrosRaw = document.getElementById("eq-membros").value.trim();
      const ativa = document.getElementById("eq-ativa").value === "true";

      const msg = document.getElementById("eq-msg");
      if(!nome){
        msg.style.display = "block";
        msg.style.color = "#b45309";
        msg.textContent = "Informe o nome da equipe.";
        return;
      }

      const membros = membrosRaw ? membrosRaw.split(",").map(x => x.trim()).filter(Boolean) : [];
      const data = getEquipes();

      if(equipeEditId){
        const idx = data.findIndex(x => Number(x.id) === Number(equipeEditId));
        if(idx >= 0){
          data[idx].nome = nome;
          data[idx].membros = membros;
          data[idx].ativa = ativa;
        }
      }else{
        data.push({ id: nextId(data), nome, ativa, membros });
      }

      setEquipes(data);
      renderEquipes();
      closeEquipeModal();

      renderManutList(document.getElementById("search-manut").value || "");
      renderHistorico(document.getElementById("search-hist").value || "", filtrosAtuais);
    }

    // ==========================================================
    // Modal: Atribuir equipe
    // ==========================================================
    const modalAtribuir = document.getElementById("modal-atribuir");
    let solicitacaoTargetId = null;

    function openAssignModal(solId){
      solicitacaoTargetId = solId;
      const data = getSolicitacoes();
      const sol = data.find(x => Number(x.id) === Number(solId));
      if(!sol) return;
      if(sol.status === "Concluído") return;

      document.getElementById("atribuir-info").textContent = `NDS ${sol.nds} • OC ${sol.oc} • ${sol.cidade}`;
      const select = document.getElementById("atribuir-equipe");
      const eqAtivas = getEquipes().filter(e => e.ativa);

      select.innerHTML = eqAtivas.length
        ? eqAtivas.map(e => `<option value="${e.id}">${e.nome}</option>`).join("")
        : `<option value="">Nenhuma equipe ativa</option>`;

      if(sol.equipeId && eqAtivas.some(e => Number(e.id) === Number(sol.equipeId))) {
        select.value = String(sol.equipeId);
      }

      modalAtribuir.classList.add("show");
    }

    function closeAssignModal(){
      modalAtribuir.classList.remove("show");
      solicitacaoTargetId = null;
    }

    function confirmAssign(){
      const select = document.getElementById("atribuir-equipe");
      const equipeId = Number(select.value);
      if(!equipeId) return;

      const data = getSolicitacoes();
      const idx = data.findIndex(x => Number(x.id) === Number(solicitacaoTargetId));
      if(idx < 0) return;
      if(data[idx].status === "Concluído") return;

      data[idx].equipeId = equipeId;
      normalizeSolicitacao(data[idx]);
      setSolicitacoes(data);

      closeAssignModal();
      renderManutList(document.getElementById("search-manut").value || "");
      renderHistorico(document.getElementById("search-hist").value || "", filtrosAtuais);
    }

    // ==========================================================
    // Modal: Concluir atendimento
    // ==========================================================
    const modalConcluir = document.getElementById("modal-concluir");
    let concluirTargetId = null;
    let concluirFotoBase64 = "";

    function resetConcluirModalUI(){
      document.getElementById("concluir-descricao").value = "";
      document.getElementById("concluir-materiais").value = "";
      document.getElementById("concluir-foto").value = "";
      concluirFotoBase64 = "";

      const img = document.getElementById("concluir-foto-preview");
      const hint = document.getElementById("concluir-foto-hint");
      img.style.display = "none";
      img.src = "";
      hint.textContent = "Nenhuma imagem selecionada.";

      const msg = document.getElementById("concluir-msg");
      msg.style.display = "none";
      msg.textContent = "";
    }

    function openConcluirModal(solId){
      concluirTargetId = solId;
      const data = getSolicitacoes();
      const sol = data.find(x => Number(x.id) === Number(solId));
      if(!sol) return;
      if(sol.status !== "Em andamento") return;

      document.getElementById("concluir-info").textContent = `NDS ${sol.nds} • OC ${sol.oc} • ${sol.cidade} • ${sol.regiao}/${sol.seccional}`;

      resetConcluirModalUI();
      modalConcluir.classList.add("show");
    }

    function closeConcluirModal(){
      modalConcluir.classList.remove("show");
      concluirTargetId = null;
      concluirFotoBase64 = "";
    }

    document.getElementById("concluir-foto").addEventListener("change", async (e) => {
      const img = document.getElementById("concluir-foto-preview");
      const hint = document.getElementById("concluir-foto-hint");
      const file = e.target.files && e.target.files[0];

      if(!file){
        img.style.display = "none";
        img.src = "";
        hint.textContent = "Nenhuma imagem selecionada.";
        concluirFotoBase64 = "";
        return;
      }

      img.src = URL.createObjectURL(file);
      img.style.display = "block";
      hint.textContent = `Arquivo: ${file.name}`;

      try{ concluirFotoBase64 = await fileToBase64(file); }
      catch(err){
        console.warn("Falha ao converter foto de conclusão:", err);
        concluirFotoBase64 = "";
      }
    });

    function confirmarConcluir(){
      const descricao = document.getElementById("concluir-descricao").value.trim();
      const materiais = document.getElementById("concluir-materiais").value.trim();
      const msg = document.getElementById("concluir-msg");

      if(!descricao){
        msg.style.display = "block";
        msg.style.color = "#b45309";
        msg.textContent = "Informe a descrição do serviço executado.";
        return;
      }

      const data = getSolicitacoes();
      const idx = data.findIndex(x => Number(x.id) === Number(concluirTargetId));
      if(idx < 0) return;
      if(data[idx].status !== "Em andamento") return;

      data[idx].status = "Concluído";
      data[idx].dataConclusao = nowBR();
      data[idx].servicoExecutado = descricao;
      data[idx].materiaisUtilizados = materiais || "";
      data[idx].fotoConclusao = concluirFotoBase64 || "";

      setSolicitacoes(data);
      closeConcluirModal();

      renderManutList(document.getElementById("search-manut").value || "");
      renderHistorico(document.getElementById("search-hist").value || "", filtrosAtuais);
    }

    // ==========================================================
    // Export helpers
    // ==========================================================
    function exportFileName(prefix){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${prefix}_${y}-${m}-${day}_${hh}${mi}`;
    }

    function csvEscape(v){
      const s = String(v ?? "");
      if(/[;"\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    function downloadBlob(content, mimeType, filename){
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    }

    function buildExportRows(items){
      return items.map(s => {
        const eq = s.equipeId ? getEquipeById(s.equipeId) : null;
        return {
          id: s.id ?? "",
          nds: s.nds ?? "",
          oc: s.oc ?? "",
          status: s.status ?? "",
          dataAbertura: s.data ?? "",
          regiao: s.regiao ?? "",
          seccional: s.seccional ?? "",
          cidade: s.cidade ?? "",
          equipamento: s.equipamento ?? "",
          tipo: s.tipo ?? "",
          equipe: eq ? eq.nome : (s.equipeId ? "(removida)" : ""),
          servicoSolicitado: s.servico ?? "",
          dataConclusao: s.dataConclusao ?? "",
          servicoExecutado: s.servicoExecutado ?? "",
          materiaisUtilizados: s.materiaisUtilizados ?? "",
          temFotoProblema: s.fotoProblema ? "Sim" : "Não",
          temFotoConclusao: s.fotoConclusao ? "Sim" : "Não"
        };
      });
    }

    // ==========================================================
    // Export: Histórico
    // ==========================================================
    function getHistoricoFiltrado(query="", filtros={}){
      const data = getSolicitacoes();
      const q = query.trim().toLowerCase();

      const filtered = data.filter(s => {
        const okBusca = !q || (s.nds + " " + s.oc + " " + s.cidade + " " + s.seccional + " " + s.regiao)
          .toLowerCase()
          .includes(q);
        if(!okBusca) return false;

        if(filtros.status && s.status !== filtros.status) return false;
        if(filtros.regiao && s.regiao !== filtros.regiao) return false;
        if(filtros.seccional && !(String(s.seccional||"").toLowerCase().includes(String(filtros.seccional).toLowerCase()))) return false;
        if(filtros.tipo && s.tipo !== filtros.tipo) return false;

        return true;
      });

      filtered.sort((a,b) => (b.id||0) - (a.id||0));
      return filtered;
    }

    function exportHistoricoCSV(){
      const query = document.getElementById("search-hist").value || "";
      const items = getHistoricoFiltrado(query, filtrosAtuais);
      const rows = buildExportRows(items);

      const headers = [
        "ID","NDS","OC","Status","Data Abertura","Região","Seccional","Cidade","Equipamento","Tipo",
        "Equipe","Serviço Solicitado","Data Conclusão","Serviço Executado","Materiais Utilizados",
        "Tem Foto Problema","Tem Foto Conclusão"
      ];
      const fields = [
        "id","nds","oc","status","dataAbertura","regiao","seccional","cidade","equipamento","tipo",
        "equipe","servicoSolicitado","dataConclusao","servicoExecutado","materiaisUtilizados",
        "temFotoProblema","temFotoConclusao"
      ];

      const sep = ";";
      let csv = "";
      csv += headers.map(csvEscape).join(sep) + "\n";
      for(const r of rows){
        csv += fields.map(f => csvEscape(r[f])).join(sep) + "\n";
      }

      const bom = "\uFEFF";
      downloadBlob(bom + csv, "text/csv;charset=utf-8;", exportFileName("historico") + ".csv");
    }

    function exportHistoricoExcel(){
      const query = document.getElementById("search-hist").value || "";
      const items = getHistoricoFiltrado(query, filtrosAtuais);
      const rows = buildExportRows(items);

      const headers = [
        "ID","NDS","OC","Status","Data Abertura","Região","Seccional","Cidade","Equipamento","Tipo",
        "Equipe","Serviço Solicitado","Data Conclusão","Serviço Executado","Materiais Utilizados",
        "Tem Foto Problema","Tem Foto Conclusão"
      ];
      const fields = [
        "id","nds","oc","status","dataAbertura","regiao","seccional","cidade","equipamento","tipo",
        "equipe","servicoSolicitado","dataConclusao","servicoExecutado","materiaisUtilizados",
        "temFotoProblema","temFotoConclusao"
      ];

      const h = (v) => String(v ?? "")
        .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;").replace(/'/g, "&#039;");

      const table = `
        <html><head><meta charset="utf-8"/></head>
        <body>
          <table border="1">
            <thead><tr>${headers.map(x => `<th>${h(x)}</th>`).join("")}</tr></thead>
            <tbody>
              ${rows.map(r => `<tr>${fields.map(f => `<td>${h(r[f])}</td>`).join("")}</tr>`).join("")}
            </tbody>
          </table>
        </body></html>
      `;

      downloadBlob(table, "application/vnd.ms-excel;charset=utf-8;", exportFileName("historico") + ".xls");
    }

    // ==========================================================
    // Export: Manutenção
    // ==========================================================
    function getManutFiltrado(query=""){
      const data = getSolicitacoes();
      const q = query.trim().toLowerCase();

      const filtered = data.filter(s => {
        if(!q) return true;
        return (s.nds + " " + s.oc + " " + s.cidade + " " + s.seccional + " " + s.regiao)
          .toLowerCase()
          .includes(q);
      });
      filtered.sort((a,b) => (b.id||0) - (a.id||0));
      return filtered;
    }

    function exportManutCSV(){
      const query = document.getElementById("search-manut").value || "";
      const items = getManutFiltrado(query);
      const rows = buildExportRows(items);

      const headers = [
        "ID","NDS","OC","Status","Data Abertura","Região","Seccional","Cidade","Equipamento","Tipo",
        "Equipe","Serviço Solicitado","Data Conclusão","Serviço Executado","Materiais Utilizados",
        "Tem Foto Problema","Tem Foto Conclusão"
      ];
      const fields = [
        "id","nds","oc","status","dataAbertura","regiao","seccional","cidade","equipamento","tipo",
        "equipe","servicoSolicitado","dataConclusao","servicoExecutado","materiaisUtilizados",
        "temFotoProblema","temFotoConclusao"
      ];

      const sep = ";";
      let csv = "";
      csv += headers.map(csvEscape).join(sep) + "\n";
      for(const r of rows){
        csv += fields.map(f => csvEscape(r[f])).join(sep) + "\n";
      }
      const bom = "\uFEFF";
      downloadBlob(bom + csv, "text/csv;charset=utf-8;", exportFileName("manutencao") + ".csv");
    }

    function exportManutExcel(){
      const query = document.getElementById("search-manut").value || "";
      const items = getManutFiltrado(query);
      const rows = buildExportRows(items);

      const headers = [
        "ID","NDS","OC","Status","Data Abertura","Região","Seccional","Cidade","Equipamento","Tipo",
        "Equipe","Serviço Solicitado","Data Conclusão","Serviço Executado","Materiais Utilizados",
        "Tem Foto Problema","Tem Foto Conclusão"
      ];
      const fields = [
        "id","nds","oc","status","dataAbertura","regiao","seccional","cidade","equipamento","tipo",
        "equipe","servicoSolicitado","dataConclusao","servicoExecutado","materiaisUtilizados",
        "temFotoProblema","temFotoConclusao"
      ];

      const h = (v) => String(v ?? "")
        .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;").replace(/'/g, "&#039;");

      const table = `
        <html><head><meta charset="utf-8"/></head>
        <body>
          <table border="1">
            <thead><tr>${headers.map(x => `<th>${h(x)}</th>`).join("")}</tr></thead>
            <tbody>
              ${rows.map(r => `<tr>${fields.map(f => `<td>${h(r[f])}</td>`).join("")}</tr>`).join("")}
            </tbody>
          </table>
        </body></html>
      `;

      downloadBlob(table, "application/vnd.ms-excel;charset=utf-8;", exportFileName("manutencao") + ".xls");
    }

    // ==========================================================
    // Form CO
    // ==========================================================
    document.getElementById("co-regiao").addEventListener("change", updateSeccionais);

    document.getElementById("co-foto").addEventListener("change", async (e) => {
      const img = document.getElementById("co-foto-preview");
      const hint = document.getElementById("co-foto-hint");

      const file = e.target.files && e.target.files[0];
      if(!file){
        img.style.display = "none";
        img.src = "";
        hint.textContent = "Nenhuma imagem selecionada.";
        return;
      }

      img.src = URL.createObjectURL(file);
      img.style.display = "block";
      hint.textContent = `Arquivo: ${file.name}`;
    });

    document.getElementById("co-limpar").addEventListener("click", () => {
      document.getElementById("co-form").reset();
      updateSeccionais();

      const img = document.getElementById("co-foto-preview");
      const hint = document.getElementById("co-foto-hint");
      img.style.display = "none";
      img.src = "";
      hint.textContent = "Nenhuma imagem selecionada.";
    });

    document.getElementById("co-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const oc = document.getElementById("co-oc").value.trim();
      const nds = document.getElementById("co-nds").value.trim();
      const regiao = document.getElementById("co-regiao").value;
      const seccional = document.getElementById("co-seccional").value;
      const cidade = document.getElementById("co-cidade").value.trim();
      const equipamento = document.getElementById("co-equip").value.trim();
      const servico = document.getElementById("co-servico").value.trim();
      const tipo = document.getElementById("co-tipo").value || "Não informado";

      const file = document.getElementById("co-foto").files && document.getElementById("co-foto").files[0];
      let fotoProblema = "";
      if(file){
        try{ fotoProblema = await fileToBase64(file); }
        catch(err){ console.warn("Falha ao converter imagem:", err); }
      }

      const data = getSolicitacoes();
      data.push({
        id: nextId(data),
        nds,
        oc,
        regiao,
        seccional,
        cidade,
        equipamento,
        servico,
        status: "Pendente",
        data: nowBR(),
        tipo,
        fotoProblema,
        equipeId: null
      });

      setSolicitacoes(data);
      document.getElementById("co-limpar").click();
      showView("manut");
      renderManutList("");
    });

    // ==========================================================
    // Navegação
    // ==========================================================
    document.getElementById("go-co").addEventListener("click", (e) => { e.preventDefault(); showView("co"); });
    document.getElementById("go-manut").addEventListener("click", (e) => { e.preventDefault(); showView("manut"); renderManutList(document.getElementById("search-manut").value || ""); });
    document.getElementById("back-from-co").addEventListener("click", (e) => { e.preventDefault(); showView("home"); });

    document.getElementById("nav-equipes").addEventListener("click", () => { showView("equipes"); renderEquipes(); });
    document.getElementById("nav-historico").addEventListener("click", () => { showView("historico"); renderHistorico(document.getElementById("search-hist").value || "", filtrosAtuais); });
    document.getElementById("co-nav-historico").addEventListener("click", () => { showView("historico"); renderHistorico(document.getElementById("search-hist").value || "", filtrosAtuais); });
    document.getElementById("nav-sair").addEventListener("click", () => { showView("home"); });

    document.getElementById("back-from-historico").addEventListener("click", (e) => { e.preventDefault(); showView("manut"); renderManutList(document.getElementById("search-manut").value || ""); });
    document.getElementById("back-from-equipes").addEventListener("click", (e) => { e.preventDefault(); showView("manut"); renderManutList(document.getElementById("search-manut").value || ""); });

    // Refresh
    document.getElementById("btn-refresh").addEventListener("click", () => { renderManutList(document.getElementById("search-manut").value || ""); });
    document.getElementById("btn-refresh-hist").addEventListener("click", () => { renderHistorico(document.getElementById("search-hist").value || "", filtrosAtuais); });

    // Busca
    document.getElementById("search-manut").addEventListener("input", (e) => { renderManutList(e.target.value); });
    document.getElementById("search-hist").addEventListener("input", (e) => { renderHistorico(e.target.value, filtrosAtuais); });

    // Filtros modal
    document.getElementById("btn-filtros").addEventListener("click", openModalFiltros);
    document.getElementById("close-filtros").addEventListener("click", closeModalFiltros);

    document.getElementById("btn-limpar-filtros").addEventListener("click", () => {
      filtrosAtuais = { status: "", regiao: "", seccional: "", tipo: "" };
      document.getElementById("filter-status").value = "";
      document.getElementById("filter-regiao").value = "";
      document.getElementById("filter-seccional").value = "";
      document.getElementById("filter-tipo").value = "";
      renderHistorico(document.getElementById("search-hist").value || "", filtrosAtuais);
      closeModalFiltros();
    });

    document.getElementById("btn-aplicar-filtros").addEventListener("click", () => {
      filtrosAtuais = {
        status: document.getElementById("filter-status").value,
        regiao: document.getElementById("filter-regiao").value,
        seccional: document.getElementById("filter-seccional").value.trim(),
        tipo: document.getElementById("filter-tipo").value
      };
      renderHistorico(document.getElementById("search-hist").value || "", filtrosAtuais);
      closeModalFiltros();
    });

    // Equipes modal
    document.getElementById("btn-nova-equipe").addEventListener("click", () => openEquipeModal(null));
    document.getElementById("close-equipe").addEventListener("click", closeEquipeModal);
    document.getElementById("btn-cancelar-equipe").addEventListener("click", closeEquipeModal);
    document.getElementById("btn-salvar-equipe").addEventListener("click", saveEquipeFromModal);

    // Atribuir modal
    document.getElementById("close-atribuir").addEventListener("click", closeAssignModal);
    document.getElementById("btn-cancelar-atribuir").addEventListener("click", closeAssignModal);
    document.getElementById("btn-confirmar-atribuir").addEventListener("click", confirmAssign);

    // Concluir modal
    document.getElementById("close-concluir").addEventListener("click", closeConcluirModal);
    document.getElementById("btn-cancelar-concluir").addEventListener("click", closeConcluirModal);
    document.getElementById("btn-confirmar-concluir").addEventListener("click", confirmarConcluir);

    // Export botões
    document.getElementById("btn-export-csv").addEventListener("click", exportHistoricoCSV);
    document.getElementById("btn-export-xls").addEventListener("click", exportHistoricoExcel);
    document.getElementById("btn-export-manut-csv").addEventListener("click", exportManutCSV);
    document.getElementById("btn-export-manut-xls").addEventListener("click", exportManutExcel);
  // Inicialização
  (async () => {
      await seedEquipesIfEmpty();
      await seedSolicitacoesIfEmpty();
      updateSeccionais();
      showView("home");
  })();
  </script>
</body>
</html>
